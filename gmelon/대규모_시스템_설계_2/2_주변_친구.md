# 1. 문제 및 설계 범위 확정

## 1.1 기능 정의 및 범위 설정

1. **주변 친구 정의:** 지리적으로 5마일(mile) 이내에 있는 친구로 정의하며, 이 수치는 설정 가능해야 함.
2. **거리 계산:** 두 사용자 사이의 직선거리로 가정함.
3. **사용자 규모 가정:** 10억 명의 사용자 중 10%인 1억 명이 이 기능을 활용한다고 가정함.
4. **동시 접속 사용자:** 일간 능동 사용자(DAU)의 10%인 천만 명이 동시에 시스템을 이용한다고 가정함.
5. **비활성 처리:** 친구 관계에 있는 사용자가 10분 이상 비활성 상태면 주변 친구 목록에서 사라지도록 처리함.

## 1.2 기능 요구사항 (Functional Requirements)

1. 사용자는 모바일 앱에서 주변 친구 목록을 확인할 수 있어야 함.
2. 각 항목에는 해당 친구까지의 **거리**와 **갱신된 시각(timestamp)**이 함께 표시되어야 함.
3. 친구 목록은 **몇 초마다 한 번씩 갱신**되어야 함.

## 1.3 비기능 요구사항 (Non-functional Requirements)

1. **낮은 지연 시간 (Low Latency):** 위치 변화가 반영되는 데 오랜 시간이 걸리지 않아야 함.
2. **안정성:** 시스템은 전반적으로 안정적이어야 하며, 때로 몇 개 데이터가 유실되는 것은 용인할 수 있음.
3. **결과적 일관성 (Eventual Consistency):** 위치 데이터 저장에 강한 일관성을 요구하지 않으며, 데이터가 복제본과 동일하게 변경되는 데 몇 초 걸리는 것은 용인할 수 있음.

## 1.4 개략적 규모 추정

1. **주변 친구 정의:** 5마일(8km) 반경 이내 친구로 정의함.
2. **위치 갱신 주기:** 친구 위치 정보는 30초 주기로 갱신함.
3. **DAU:** 매일 주변 친구 기능을 활용하는 사용자는 1억 명으로 가정함.
4. **동시 접속 사용자:** 천만 명으로 가정함.
5. **평균 친구 수:** 사용자는 평균 400명의 친구를 가지며, 모두 이 기능을 활용한다고 가정함.
6. **위치 정보 갱신 QPS (Query Per Second):** 천만 명의 사용자가 30초마다 위치를 전송하면 초당 334,000번의 위치 정보 갱신 요청을 처리해야 함.

# 2. 개략적 설계안 제시 및 동의 구하기
## 2.1 개략적 설계안의 핵심 문제 및 구성 요소

1. **핵심 문제:** 활성 상태 친구의 새 위치 정보를 클라이언트에게 효과적으로 **전송(push)**하는 설계가 필요함.
2. **고부하 문제:** 천만 명의 동시 접속 환경에서 `초당 334,000번의 위치 갱신 요청`이 발생하며, 이로 인해 `초당 1400만(334,000 x 400 x 10%)건의 위치 정보 갱신 내역`을 사용자 단말로 보내야 하는 엄청난 양의 트래픽이 발생함.
3. **주요 컴포넌트:** 개략적 설계안은 **로드밸런서, 웹소켓** 서버 **클러스터, RESTful API** 서버, 레디스 **펍/섭**, 위치 정보 **캐시**, 사용자 **데이터베이스**, 위치 이동 이력 **데이터베이스**로 구성됨.

## 2.2 주요 컴포넌트 역할

![image.png](attachment:d90979e2-f13b-40b0-bbf6-623e44a5ceb9:image.png)

1. **로드밸런서:** 유상태(stateful) 웹소켓 서버와 무상태(stateless) RESTful API 서버 앞단에 위치하여 부하를 고르게 분산함.
2. **RESTful API 서버:** 사용자 추가/삭제, 정보 갱신 등 통상적인 요청/응답 처리를 담당하는 무상태 서버 클러스터임.
    
    ![image.png](attachment:1875492c-10ce-46f5-b3ae-e6d97ad77ac2:image.png)
    
3. **웹소켓 서버 (WS):** 친구 위치 정보 변경을 거의 실시간으로 처리하는 **유상태 서버 클러스터**임.
    - 각 클라이언트는 한 대의 웹소켓 서버와 지속적인 연결을 유지함.
    - 검색 반경 내 친구 위치가 변경되면 이 연결을 통해 클라이언트로 내역이 전송됨.
    - 초기화 시, 클라이언트의 모든 주변 친구 위치를 찾아 전송하는 역할도 함.
4. **레디스 위치 정보 캐시:** 활성 상태 사용자의 가장 최근 위치 정보를 캐시함.
    - 캐시 항목에는 **TTL(Time-To-Live)**이 설정되어, 기간이 지나면 사용자는 비활성 상태로 바뀌고 정보는 삭제됨.
5. **레디스 펍/섭 서버 (Pub/Sub):** 초경량 메시지 버스 역할을 하며, 새로운 채널 생성 비용이 아주 저렴함.
    
    ![image.png](attachment:464c601e-72df-49d8-947b-0060498663d6:image.png)
    
    - 특정 사용자의 위치 변경 이벤트는 해당 사용자에게 배정된 펍/섭 채널에 **발행(publish)**됨.
    - 해당 사용자의 친구와 연결된 웹소켓 연결 핸들러는 해당 채널의 **구독자(subscriber)**로 설정됨.
    - 위치 변경 이벤트 수신 시, 웹소켓 핸들러는 거리를 재계산하여 검색 반경 이내면 갱신된 위치와 시각을 클라이언트 앱으로 전송함.
6. **사용자 데이터베이스:** 사용자 데이터 및 친구 관계 정보를 저장함.
7. **위치 이동 이력 데이터베이스:** 사용자의 위치 변동 이력을 보관함 (주변 친구 기능과 직접 관계는 없음).

## 2.3 주기적 위치 갱신 흐름

![image.png](attachment:3783ab34-d90e-41fa-8826-07634abc0877:image.png)

1. **클라이언트 전송:** 모바일 클라이언트가 웹소켓 연결을 통해 위치 변경 내역을 로드밸런서에 전송함.
2. **WS 서버 수신:** 로드밸런서는 이를 웹소켓 서버로 보냄.
3. **이력 저장:** 웹소켓 서버는 해당 이벤트를 위치 이동 이력 데이터베이스에 저장함 (병렬 수행).
4. **캐시 갱신:** 웹소켓 서버는 새 위치를 위치 정보 캐시에 보관하고 TTL을 갱신하며, 연결 핸들러 내 변수에도 반영함 (병렬 수행).
5. **펍/섭 발행:** 웹소켓 서버는 레디스 펍/섭 서버의 해당 사용자 채널에 새 위치를 발행함 (병렬 수행).
6. **구독자 브로드캐스트:** 발행된 위치 이벤트는 모든 구독자(온라인 상태 친구들의 웹소켓 핸들러)에게 브로드캐스트됨.
7. **거리 계산 및 전송:** 메시지를 받은 웹소켓 서버는 보낸 사용자와 수신 사용자 사이의 거리를 새로 계산함.
8. **결과 전송:** 계산된 거리가 검색 반경을 넘지 않으면, 새 위치 및 타임스탬프를 해당 구독자의 클라이언트 앱으로 전송함.
9. **예제**
    
    ![image.png](attachment:aef56acd-fa82-4f12-badd-cbf8907e9515:image.png)
    

## 2.4 WS API 설계

| **종류** | **개요** | **요청** | **응답** |
| --- | --- | --- | --- |
| `서버 API` | 1. 주기적인 위치 정보 갱신 API | 위도, 경도, 시각 정보 전송 | 없음 |
| `클라이언트 API` | 2. 갱신된 친구 위치를 수신하는 API | 없음 | 친구 위치 데이터와 변경 시각 |
| `서버 API` | 3. 웹소켓 초기화 API | 위도, 경도, 시각 정보 전송 | 자기 친구들의 위치 데이터 수신 |
| `클라이언트 API` | 4. 새 친구 구독 API | 친구 ID 전송 | 가장 최근의 위도, 경도, 시각 정보 전송 |
| `클라이언트 API` | 5. 구독 해지 API | 친구 ID 전송 | 없음 |

## 2.5 데이터 모델

1. **위치 정보 캐시 (레디스)**
    - **목적:** '주변 친구' 기능을 활성화한 친구의 가장 최근 위치를 보관함.
    - **형태:** 키(사용자 ID) / 값({위도, 경도, 시각}) 쌍으로 보관함.
    - **특징:** 레디스는 읽기/쓰기 연산 속도가 빠르며, TTL을 지원하여 비활성 사용자 정보를 자동 제거함.
    - **영속성:** 위치 정보에 대해 영속성(durability)을 보장할 필요가 없으므로, 서버 장애 시 새 서버로 교체하고 캐시가 채워지기를 기다리면 됨.
2. **위치 이동 이력 데이터베이스**
    - **목적:** 사용자의 위치 변경 이력을 저장함.
    - **스키마:** latitude, longitude, timestamp, user_id를 따름.
    - **확장성:** 막대한 쓰기 부하를 감당하고 수평적 확장이 가능해야 하므로, **카산드라(Cassandra)**와 같은 NoSQL 데이터베이스가 적합함.
    - **샤딩:** 사용자 ID를 기준으로 샤딩하여 부하를 분산하고 운영 관리를 간편하게 함.