# 11장 결제 시스템

# 1단계: 문제 이해 및 설계 범위 확정

1. **결제 시스템의 정의 및 중요성**
    - 결제 시스템은 금전적 가치 이전을 통해 금융 거래를 정산하는 데 사용되는 모든 제도, 절차, 기술을 포함함
    - 전자상거래의 폭발적인 성장에 필수적이며, 작은 실수도 큰 매출 손실로 이어질 수 있는 부담스러운 시스템임
2. **설계 범위 확정 (전자상거래 환경 가정)**
    - **대상 애플리케이션:** 아마존닷컴과 같은 전자상거래 애플리케이션의 결제 백엔드를 구축하는 것을 가정함
    - **지원 결제 방법:** 실생활에서 사용 가능한 모든 옵션을 지원해야 하지만, 이번 면접에서는 **신용 카드 결제**만 처리하는 것으로 한정함
    - **결제 처리 주체:** 신용 카드 데이터의 보안 및 법규 준수(PCI DSS 등) 문제로 인해, 민감한 데이터 처리는 스트라이프(Stripe) 같은 **전문 결제 처리 업체(PSP)**에 의존함
    - **국제 지원:** 전 세계적으로 사용될 수 있는 애플리케이션이지만, 면접에서는 **하나의 통화**만 사용한다고 가정함
    - **규모:** 하루 **100만 건의 거래**가 이루어진다고 가정함 (초당 약 10TPS)
    - **추가 요구사항:** 판매자에게 매월 지급 대금을 정산하는 절차(Pay-out)를 지원해야 함
3. **기능 및 비기능 요구사항**
    - **기능 요구사항:** 대금 수신, 대금 정산
    - **비기능 요구사항:** 신뢰성 및 내결함성, 내부 서비스 간 조정 프로세스

# 2단계: 개략적 설계안 제시 및 동의 구하기

## 2.1. 결제 자금의 흐름 (Pay-in 및 Pay-out)

1. **대금 수신 (Pay-in) 흐름**
    - 구매자가 주문하면 돈이 아마존의 은행 계좌로 들어옴
    - 이 돈의 소유권은 대부분 판매자에게 있으며, 아마존은 수수료를 받고 자금 관리자 역할만 수행함
2. **대금 정산 (Pay-out) 흐름**
    - 제품이 배송되는 등 조건이 충족되면, 판매 대금에서 수수료를 제외한 잔액이 판매자의 은행 계좌로 지급됨

## 2.2. 대금 수신 흐름의 구성 요소

1. **결제 서비스 (Payment Service)**
    - 사용자로부터 결제 이벤트를 수락하고 AML/CFT(자금 세탁 방지/테러 자금 조달 방지)와 같은 규정을 준수하는지 위험 점검(risk check)을 수행함
    - 위험 확인을 통과한 결제만 처리하며, 일반적으로 복잡성 때문에 제3자 제공업체(PSP)를 이용함
2. **결제 실행자 (Payment Executor)**
    - 하나의 결제 이벤트에 포함될 수 있는 여러 **결제 주문(payment order)** 중 하나를 PSP를 통해 실행하는 역할을 담당함
3. **결제 서비스 공급자 (PSP, Payment Service Provider)**
    - 구매자의 신용 카드 계정에서 돈을 인출하여 전자상거래 웹사이트의 계좌로 옮기는 역할을 담당함 (예: Toss Payments, NHN KCP, NICE 정보통신, …)
4. **카드 유형 (Card Scheme)**
    - 신용 카드 업무를 처리하는 조직으로, 비자(VISA), 마스터카드(MasterCard) 등이 있음
5. **원장 (Ledger)**
    - 결제 트랜잭션에 대한 금융 기록을 저장함
    - 총 수익 계산, 수익 분석 등 **결제 후 분석(post-payment analysis)**에 매우 중요한 역할을 함
6. **지갑 (Wallet)**
    - 특정 사용자나 판매자(merchant)의 계정 잔액을 기록함

## 2.3. 일반적인 결제 흐름 (9단계)

1. 사용자가 '주문하기' 클릭 시 결제 이벤트가 생성되어 결제 서비스로 전송되고 데이터베이스에 저장됨
2. 결제 서비스는 결제 이벤트를 데이터베이스에 저장함
3. 단일 결제 이벤트에 여러 판매자의 제품이 포함된 경우, 결제 서비스는 이를 여러 결제 주문으로 분할하고 결제 실행자를 호출함
4. 결제 실행자는 결제 주문을 데이터베이스에 저장함
5. 결제 실행자는 PSP를 외부 호출하여 신용 카드 결제를 처리함
6. 결제 실행자가 결제를 성공적으로 처리하면 지갑 서비스를 호출하여 특정 판매자의 잔고를 갱신함
7. 지갑 서버는 갱신된 잔고 정보를 데이터베이스에 저장함
8. 지갑 서비스가 잔고 갱신에 성공하면 결제 서비스는 원장 서비스를 호출하여 원장 데이터베이스에 새 정보를 추가함
9. 원장 서비스는 원장 데이터베이스에 새 정보를 추가함
