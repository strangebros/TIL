## 개요

- 7장에서는 '최소 한 번' 전달에 초점을 맞춤 (메시지가 유실되지 않음이 보장됨)
- 하지만 여전히 메시지 중복의 가능성은 존재

### 문제가 되는 예시

- 특정 이벤트를 읽어 평균을 계산하고 결과를 산출하는 애플리케이션의 경우, 결과만 보는 입장에서는 어떤 이벤트가 두 번 처리되어 평균값이 잘못 계산된 사실을 알아내기 어려움
    - 즉, 이벤트가 중복 처리되어도 결과만으로는 오류를 쉽게 감지할 수 없음

### 카프카의 '정확히 한 번'

- `멱등적 프로듀서` & `트랜잭션`의 조합으로 이루어짐
    - 멱등적 프로듀서: 프로듀서 재시도로 인해 발생하는 중복을 방지
    - 트랜잭션: 스트림 처리 애플리케이션에서 '정확히 한 번' 처리를 보장

## 8.1 멱등적 프로듀서

### 멱등적

- 동일한 작업을 여러 번 실행해도 한 번 실행한 것과 결과가 같은 서비스

### 메시지 중복이 발생할 수 있는 '최소 한 번' 케이스

1. 파티션 리더가 프로듀서로부터 레코드를 받아 팔로워들에게 성공적으로 복제
2. 프로듀서에게 응답을 보내기 전에 파티션 리더가 있는 브로커에 크래시가 발생
3. 프로듀서는 응답을 받지 못해 타임아웃이 발생하고 메시지를 재전송
4. 재전송된 메시지가 새 리더에 도착하지만 이미 저장된 메시지이므로 중복이 발생

### 8.1.1 멱등적 프로듀서의 작동 원리

- 멱등적 프로듀서 기능을 켜면, 모든 메시지는 `고유한 프로듀서 ID` 와 `시퀀스 넘버`를 가짐
    - `대상 토픽 & 파티션 & 프로듀서 ID & 시퀸스 넘버` 를 합치면 각 메시지의 고유한 식별자가 됨
    - 각 브로커는 파티션에 쓰여진 마지막 5개 메시지들을 추적하기 위해 이 고유 식별자를 사용
    - 예전에 받은 적이 있는 메시지를 받게 될 경우, 에러를 발생시켜 중복 메시지를 거부
    - `max.in.flight.requests.per.connection`
        - 하나의 브로커 연결에서 응답을 받지 않은 채로 동시에 전송할 수 있는 최대 요청 수
        - 이 값이 5 이하여야, 파티션 별로 추적되어야 하는 시퀸스 넘버의 수를 제한할 수 있다.
- 만약 예상보다 높은 시퀀스 넘버를 받게 된다면?
    - e.g. 2번 다음 3번을 기대했는데, 27번 메시지를 받은 경우
    - 브로커는 `out of order sequence number` 에러를 발생시킴
    - 단, `트랜잭션` 없이 멱등적 프로듀서 기능만 사용할 것이라면 이 오류는 무시 가능
    - 설정은 잘 되어 있는지, 언클린 리더 선출이 발생되었는지 등을 확인할 필요가 있음

### 작동이 실패했을 경우, 멱등적 프로듀서가 어떻게 처리하는가?

1. 프로듀서 재시작 케이스
    1. 보통 새 프로듀서를 생성해 (직접 또는 쿠버네티스 환경 등) 장애가 난 프로듀서를 대체
    2. 멱등적 프로듀서 기능이 켜져있는 경우, 초기화 과정에서 브로커로 부터 프로듀서 ID 를 생성받음
        1. 트랜잭션 기능을 켜지 않은 경우, 프로듀서 초기화 시 마다 완전히 새로운 프로듀서 ID 를 생성
    3. 즉, 기존 프로듀서가 이미 전송한 메시지를 다시 전송해도 중복을 알아차릴 수 없음 (식별자가 달라지기 때문)
2. 브로커 장애 케이스
    1. 컨트롤러는 장애가 난 브로커가 리더를 맡고 있었던 파티션들에 대해 새 리더를 선출
        1. 프로듀서는 **메타데이터 프로토콜**을 통해 새로운 브로커가 리더임을 알아차리고 거기로 메시지를 쓰기 시작
    2. **하지만 새로운 리더 브로커 입장에서 어느 시퀀스 넘버까지 쓰여졌는지 알고, 중복 메시지를 걸러내는가?**
        1. 리더는 새 메시지가 쓰여질 때마다 인-메모리 프로듀서 상태에 저장된 초근 5개의 시퀸스 넘버를 업데이트
        2. 팔로워는 리더로부터 새로운 메시지를 복제할 때마다 자체적인 인-메모리 버퍼를 업데이트
        3. 즉, 팔로워가 리더가 된 시점에는 이미 메모리 안에 최근 5개의 시퀸스 넘버를 가지고 있게 되어, 아무런 지연 없이 새로운 메시지에 대한 유효성 검증이 재개될 수 있음
    3. 하지만, 갑자기 이전 리더가 다시 복구된다면?
        1. 인-메모리 프로듀서 상태는 더 이상 메모리에 없음
        2. 브로커는 복구에 도움이 될 수 있도록 종료되거나 새 세그먼트가 생성될 때마다 프로듀서 상태를 스냅샷 파일로 저장
        3. 브로커가 시작되면 스냅샷 + 현재 리더로부터 복제한 레코드를 사용해 최신 상태를 복구
            1. 브로커가 다시 리더가 될 수 있는 시점에는 최신 시퀀스 넘버를 갖게 됨
        4. 최신 스냅샷이 업데이트 되지 않더라도, 프로듀서 ID 와 시퀸스 넘버는 메시지에 저장되므로 파티션에 저장된 세그먼트들을 읽어와서 최신 상태로 복구가 가능함
    4. 만얀 메시지 보존 기간동안 들어온 메시지가 하나도 없다면?!
        1. 복구는 불가능하겠지만, 중복이 없다는 이야기이기도 하므로 그냥 신규 메시지부터 처리하면 됨 (프로듀서 상태가 없다는 경고메시지는 발생)