## 개요

- 7장에서는 '최소 한 번' 전달에 초점을 맞춤 (메시지가 유실되지 않음이 보장됨)
- 하지만 여전히 메시지 중복의 가능성은 존재

### 문제가 되는 예시

- 특정 이벤트를 읽어 평균을 계산하고 결과를 산출하는 애플리케이션의 경우, 결과만 보는 입장에서는 어떤 이벤트가 두 번 처리되어 평균값이 잘못 계산된 사실을 알아내기 어려움
    - 즉, 이벤트가 중복 처리되어도 결과만으로는 오류를 쉽게 감지할 수 없음

### 카프카의 '정확히 한 번'

- `멱등적 프로듀서` & `트랜잭션`의 조합으로 이루어짐
    - 멱등적 프로듀서: 프로듀서 재시도로 인해 발생하는 중복을 방지
    - 트랜잭션: 스트림 처리 애플리케이션에서 '정확히 한 번' 처리를 보장

## 8.1 멱등적 프로듀서

### 멱등적

- 동일한 작업을 여러 번 실행해도 한 번 실행한 것과 결과가 같은 서비스

### 메시지 중복이 발생할 수 있는 '최소 한 번' 케이스

1. 파티션 리더가 프로듀서로부터 레코드를 받아 팔로워들에게 성공적으로 복제
2. 프로듀서에게 응답을 보내기 전에 파티션 리더가 있는 브로커에 크래시가 발생
3. 프로듀서는 응답을 받지 못해 타임아웃이 발생하고 메시지를 재전송
4. 재전송된 메시지가 새 리더에 도착하지만 이미 저장된 메시지이므로 중복이 발생

### 8.1.1 멱등적 프로듀서의 작동 원리

- 멱등적 프로듀서 기능을 켜면, 모든 메시지는 `고유한 프로듀서 ID` 와 `시퀀스 넘버`를 가짐
    - `대상 토픽 & 파티션 & 프로듀서 ID & 시퀸스 넘버` 를 합치면 각 메시지의 고유한 식별자가 됨
    - 각 브로커는 파티션에 쓰여진 마지막 5개 메시지들을 추적하기 위해 이 고유 식별자를 사용
    - `max.in.flight.requests.per.connection`
        - 하나의 브로커 연결에서 응답을 받지 않은 채로 동시에 전송할 수 있는 최대 요청 수
        - 이 값이 5 이하여야, 파티션 별로 추적되어야 하는 시퀸스 넘버의 수를 제한할 수 있다.