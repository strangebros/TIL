## ê¶ê¸ˆì¦ ğŸ¤”

íšŒì‚¬ì—ì„œ ìµœê·¼ ì¹´í”„ì¹´ë¥¼ ë„ì…í–ˆëŠ”ë°, ë™ê¸°ì‹ í˜¸ì¶œ ëŒ€ì‹  ì¹´í”„ì¹´ë¥¼ ì“°ë©´ ì„±ëŠ¥ì´ ì¢‹ì•„ì§„ë‹¤ëŠ” ë§ì„ ìì£¼ ë“£ëŠ”ë‹¤. ê·¼ë° ì •í™•íˆ ì–´ë–¤ ì›ë¦¬ì¸ì§€ ê¶ê¸ˆí•´ì¡Œë‹¤.

íŠ¹íˆ **ì»¨ìŠˆë¨¸ê°€ ìì‹ ì´ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ë§Œí¼ë§Œ ë©”ì‹œì§€ë¥¼ ê°€ì ¸ê°„ë‹¤**ëŠ” ê²Œ ì–´ë–»ê²Œ ë™ì‘í•˜ëŠ”ê±´ì§€ ì´í•´í•˜ê³  ì‹¶ë‹¤.

## 1. Pull ë°©ì‹

ì¹´í”„ì¹´ëŠ” **Pull ëª¨ë¸**ì„ ì“´ë‹¤.

ì»¨ìŠˆë¨¸ê°€ ìš”ì²­í•˜ë©´ ë¸Œë¡œì»¤ê°€ ë©”ì‹œì§€ë¥¼ ì£¼ëŠ” ë°©ì‹ì´ë‹¤. ì»¨ìˆ˜ë¨¸ëŠ” ê¸°ì¡´ ë©”ì„œì§€ê°€ ì²˜ë¦¬ ì™„ë£Œë˜ë©´ ë‹¤ì‹œ ë¸Œë¡œì»¤ì—ê²Œ ë©”ì‹œì§€ë¥¼ ìš”ì²­í•œë‹¤.

## ì»¨ìŠˆë¨¸ ì¡°ì ˆ ë°©ë²•

### ê¸°ë³¸ì ì¸ ë°©ë²•

```java
Properties props = new Properties();
props.put("max.poll.records", 100); // í•œ ë²ˆì— 100ê°œë§Œ ë‹¬ë¼ê³  í•¨

while (true) {
    ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(1000));
    
    for (ConsumerRecord<String, String> record : records) {
        processMessage(record); // í•˜ë‚˜ì”© ì²˜ë¦¬
    }
    
    consumer.commitSync(); // ë‹¤ ì²˜ë¦¬í–ˆë‹¤ê³  ì•Œë¦¼
}
```

ì´ë ‡ê²Œ í•˜ë©´ ì»¨ìŠˆë¨¸ê°€ 100ê°œ ì²˜ë¦¬í•˜ëŠ”ë° 10ì´ˆ ê±¸ë¦°ë‹¤ë©´, 10ì´ˆë§ˆë‹¤ 100ê°œì”©ë§Œ ìš”ì²­í•œë‹¤.

### ì¶”ê°€ ì„¤ì •ë“¤

```properties
fetch.min.bytes=1048576    # ìµœì†Œ 1MB ìŒ“ì¼ë•Œê¹Œì§€ ëŒ€ê¸°
fetch.max.wait.ms=500      # ë‹¨, ìµœëŒ€ 500msë§Œ ëŒ€ê¸°
```

ìœ„ ì„¤ì •ìœ¼ë¡œ ì‘ì€ ë©”ì‹œì§€ë“¤ì„ ëª¨ì•„ì„œ ë°°ì¹˜ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.

## ì—¬ëŸ¬ ê°€ì§€ ì²˜ë¦¬ ë°©ë²•ë“¤

### 1. Springì´ ì œê³µí•˜ëŠ” ì¶”ìƒí™” í™œìš© (ì¼ë°˜ì )
```java
@KafkaListener(topics = "order-events")
public void handleEvents(List<OrderEvent> events) {
    
    for (OrderEvent event : events) {
        processOrder(event); // 10ì´ˆ ì†Œìš”
    }
    
    // 10ì´ˆ í›„ì—ì•¼ ë‹¤ìŒ poll() ì‹¤í–‰ë¨
    // ìì—°ìŠ¤ëŸ½ê²Œ ì²˜ë¦¬ ì†ë„ ì¡°ì ˆ
}
```

#### ë°±í”„ë ˆì…”
ìƒì‚°ìê°€ ë³´ë‚´ëŠ” ì†ë„ > ì»¨ìŠˆë¨¸ê°€ ì²˜ë¦¬í•˜ëŠ” ì†ë„ ì¼ ë•Œ ë°œìƒí•˜ëŠ” ìƒí™©ì„ ì œì–´í•˜ëŠ” ë©”ì»¤ë‹ˆì¦˜.
```
// Backpressure ê°€ ì—†ëŠ” ê²½ìš°
Producer(1000/sec) -> Consumer(100/sec) -> ğŸ’¥ ì‹œìŠ¤í…œ ë‹¤ìš´

// Backpressure ë¥¼ ì ìš©í•œ ê²½ìš°
Producer(1000/sec) -> Kafka Broker -> Consumer(100/sec) âœ…
                       (í ì—­í• )      (ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ ê°€ëŠ¥)
```

### 2. ì„ì˜ë¡œ sleep() ì„ ê±°ëŠ” ë°©ë²•
* https://techblog.woowahan.com/20156/
  * db ë“± ë‹¤ë¥¸ ìì›ì— ì œì•½ì´ ê±¸ë ¤ìˆì„ ë•Œ ìœ ìš©í•œ ë°©ë²•
```java
@Component
public class FlowControlConsumer {

    private final KafkaListenerEndpointRegistry registry;
    
    @KafkaListener(topics = "order-events", id = "orderConsumer")
    public void handleEvents(List<OrderEvent> events) {
        
        if (isSystemOverloaded()) {
            // ì»¨ìŠˆë¨¸ ì¼ì‹œì •ì§€
            registry.getListenerContainer("orderConsumer").pause();
            
            // ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ ë³µêµ¬ ë¡œì§ ì‹¤í–‰
            scheduleResume();
            return;
        }
        
        events.forEach(this::processOrder);
    }
}
```

## 2. ì»¨ìŠˆë¨¸ ê·¸ë£¹ê³¼ íŒŒí‹°ì…˜

ì¹´í”„ì¹´ì˜ íŠ¹ì¥ì ì€ **ìˆ˜í‰ í™•ì¥**ì´ ì‰½ë‹¤ëŠ” ê²ƒ.

íŒŒí‹°ì…˜ì´ 3ê°œ ìˆìœ¼ë©´ ì»¨ìŠˆë¨¸ë„ ìµœëŒ€ 3ê°œê¹Œì§€ ë¶™ì¼ ìˆ˜ ìˆë‹¤ (ê°™ì€ ì»¨ìˆ˜ë¨¸ ê·¸ë£¹ ë‚´ì—ì„œ). ê° ì»¨ìˆ˜ë¨¸ê°€ ê° íŒŒí‹°ì…˜ì„ ë‹´ë‹¹í•œë‹¤.