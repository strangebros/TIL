## 1. 리밸런싱 프로토콜의 두 가지 흐름

현재 카프카는 과거의 비효율을 개선하기 위해 두 가지 프로토콜을 사용함.

* **Eager Rebalancing (전통적):** "Stop-the-World" 방식. 모든 컨슈머가 소비를 멈추고 파티션을 재배치함.
* **Incremental Cooperative Rebalancing (최신):** 영향이 있는 파티션만 이동시키며, 나머지는 중단 없이 소비를 계속함.

## 2. 시나리오별 상세 메커니즘

### ① 신규 컨슈머의 그룹 합류 (Scale-out)

신규 인스턴스가 투입되었을 때의 내부 시퀀스임.

1. **FindCoordinator:** 컨슈머는 브로커 중 `__consumer_offsets` 파티션의 리더를 찾아 코디네이터로 지정함.
2. **JoinGroup 요청:** 신규 컨슈머가 코디네이터에게 합류 요청을 보냄.
3. **Preparing Rebalance:** 코디네이터는 기존 멤버들에게 Heartbeat 응답을 통해 리밸런싱 시작을 알림.
4. **Member Revocation:** 기존 컨슈머들이 현재 소유한 파티션을 반납(Revoke)하고 `JoinGroup` 요청을 보냄.
5. **Leader Election & SyncGroup:** 코디네이터는 가장 먼저 도착한 컨슈머를 **리더**로 선정. 리더는 할당 전략(Assignor)에 따라 파티션 맵을 짜서 코디네이터에게 전송(`SyncGroup`).
6. **Assignment Distribution:** 코디네이터가 모든 멤버에게 최종 할당표를 전달하며 종료.

### ② 컨슈머의 비정상 종료 (Session Timeout)

네트워크 단절이나 프로세스 크래시 발생 시의 메커니즘임.

* **감지 루프:** 컨슈머 내의 별도 **Heartbeat Thread**가 주기적으로 코디네이터에게 생존 신호를 보냄.
* **Timeout 발생:** 코디네이터가 `session.timeout.ms` 동안 신호를 받지 못하면 해당 컨슈머를 `Dead` 상태로 변경.
* **즉시 리밸런싱:** 코디네이터는 해당 컨슈머가 소유했던 파티션을 '부유 상태'로 만들고, 남은 멤버들에게 다음 Heartbeat 응답 시 리밸런싱을 명령함.
* **결과:** 장애가 발생한 컨슈머의 파티션만 다른 정상 컨슈머에게 재할당됨.

### ③ 비즈니스 로직 처리 지연 (Poll Timeout)

코드 레벨에서 가장 많이 발생하는 장애 시나리오임.

* **메커니즘:** 하트비트 스레드는 정상이지만, 메인 스레드의 처리 속도가 너무 느려 `poll()` 호출 간격이 `max.poll.interval.ms`를 초과함.
* **Self-Leave:** 컨슈머 스스로 "나는 더 이상 메시지를 처리할 능력이 없다"고 판단하여 `LeaveGroup` 요청을 보내고 그룹에서 나감.
* **중복 처리 위험:** 이때 리밸런싱이 발생하면서 다른 컨슈머가 동일 파티션을 할당받으면, 아직 처리 중인 이전 컨슈머와 충돌하여 **메시지 중복 처리**가 발생할 수 있음.

### ④ Incremental Cooperative Rebalancing (Kafka 2.4+)

전체 중단을 피하기 위한 최신 메커니즘임.

1. **1차 리밸런싱:** 코디네이터가 리밸런싱을 트리거해도 모든 컨슈머는 기존 파티션을 유지함.
2. **계산:** 리더 컨슈머가 할당 전략을 돌려 "이동이 필요한 파티션"만 선별함.
3. **2차 리밸런싱:** 이동 대상 파티션만 반납(Revoke)하고, 해당 파티션들만 새로운 컨슈머에게 할당함.

* **장점:** 대규모 컨슈머 그룹에서 리밸런싱 시 발생하는 지연 시간(Lag)을 최소화함.

## 3. 리밸런싱 최적화 핵심 파라미터 정리

| 파라미터 | 권장 설정 및 전략 |
| --- | --- |
| **session.timeout.ms** | 너무 짧으면 일시적 네트워킹 불안정에도 리밸런싱 발생. 보통 10~45초 권장. |
| **max.poll.interval.ms** | 가장 긴 비즈니스 로직 처리 시간보다 넉넉하게 설정해야 'Stuck' 판정을 피함. |
| **group.instance.id** | **Static Membership** 활성화. 컨슈머 재시작 시 리밸런싱을 방지하는 실무 필수 설정. |
| **partition.assignment.strategy** | `CooperativeStickyAssignor` 사용 권장 (점진적 리밸런싱 지원). |

## 4. 리밸런싱 방지 전략

1. **배포 전략:** Static Membership을 사용하여 롤링 업데이트 시 발생하는 불필요한 리밸런싱을 차단함.
2. **모니터링:** `kafka_consumergroup_rebalance_rate_total` 메트릭을 감시하여 리밸런싱이 빈번한지 체크함.
3. **예외 처리:** 비즈니스 로직 내에서 예외가 발생해 `poll()` 루프가 깨지지 않도록 `try-catch`를 견고하게 설계함.