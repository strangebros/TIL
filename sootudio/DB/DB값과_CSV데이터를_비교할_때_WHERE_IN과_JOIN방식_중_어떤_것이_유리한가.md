## ❓궁금증
오늘은 업무를 하다가 다음과 같은 궁금증이 생겼습니다.

> DB값과 CSV파일의 값을 비교해서 일치하는 컬럼들을 찾아야 할 때, `WHERE IN` 방식을 사용하는 것이 유리한가? 아니면 임시 테이블을 만들어서 `JOIN`을 사용하는 방식이 유리한가?

사실 JOIN이 더 유리할거라는 예상 정도는 하고 있었는데, 정확한 이유를 몰라서 자세히 찾아봤습니다.

## ❗데이터 적을 때: `WHERE IN`, 데이터 많을 때: `JOIN`
결론부터 말하자면, `JOIN` + 임시 테이블이 대량 데이터에서 훨씬 유리하다고 합니다.
- 이때, 임시 테이블에 인덱스를 걸면 `INNER JOIN`, `LEFT JOIN` 등으로 성능도 확보됩니다.
- `WHERE IN`은 비교적 소량 데이터에 적합하지만, 수천 건이 넘어가면 오히려 쿼리 파싱, 캐시, 실행 속도 등에서 비효율적이라고 합니다.

실무에서는 몇 백건 정도의 소량 데이터라면 `WHERE IN`도 OK이지만, 1000건 이상이라면 `JOIN`구조를 추천한다고 합니다.
이때, 기본적으로 임시 테이블을 만들고 조회를 하는 구문은 다음과 같습니다.

```sql
-- temp table 생성
CREATE TEMPORARY TABLE temp_company (
  name VARCHAR(255)
);

-- CSV 내용을 temp_company에 insert(IDE의 자체 Load Data 기능을 사용해도 가능)

-- JOIN으로 비교
SELECT t.*
FROM real_company t
JOIN temp_company c ON t.name = c.name;

```

### TEMPORARY 키워드가 뭐지?
제가 생각한 임시 테이블은 그냥 이름만 `temp_abc`로 짓고, 나중에 삭제하는 테이블을 생각했는데, SQL의 선구자 분들은 `TEMPORARY`라는 아름다운 키워드를 남겨 두셨다는걸 알게 되었습니다.

사실 그냥 테이블을 만드는 것과 똑같이 임시 테이블을 만들면, 운영 시에 다음과 같은 문제가 생길 수 있습니다.

| 유형 | 설명 | 영향 |
| --- | --- | ---|
| DROP 누락 | 임시 테이블 생성 후 삭제(`DROP`) 안함 | 테이블 잔존, 다른 작업에 영향 |
| 이름 중복 | 동일한 테이블명이 남아 있음 | `CREATE TABLE` 실패 또는 의도치 않은 데이터 오염 |
| 트랜잭션 롤백 미흡 | 작업 실패 후 롤백 없이 테이블 남아있음 | 예기치 않은 결과 발생 가능 |
| 공유 환경 충돌 | 다중 사용자/세션에서 동일 테이블명 사용 | 충돌, 데이터 유실 가능성 |

이 모든 것을 해결할 수 있는 키워드가 바로 `TEMPORARY`입니다.
`TEMPORARY` 키워드를 통해 테이블을 생성하면, 일반 `TABLE`과는 다르게 "임시 테이블"을 만들겠다는 의미라고 합니다.
이 `TEMPORARY TABLE`은 세션 또는 연결(Connection) 단위로만 존재하며, 자동으로 삭제되는 특별한 성격을 가집니다.

> 즉, "현재 세션에서만 유효한 임시 테이블을 만든다"는 뜻으로 `TEMPORARY`키워드를 쓴다고 합니다.

`TEMPORARY`를 사용하여 만든 임시 테이블에는 다음과 같은 특징이 있습니다.
#### 1. 세션 범위 제한
- 테이블은 생성한 DB 세션(=DB 연결) 에서만 접근이 가능합니다. 당연하겠지만 새 세션을 열면 테이블이 안 보인다는 주의사항도 있습니다.
#### 2. 자동 삭제
- 세션이 종료되면 자동으로 삭제됩니다.(명시적 DROP이 불필요 합니다. 그럼에도 명시적으로 `DROP TEMPORARY TABLE`을 하는 것이 안전하다고 합니다.)
#### 3. 다른 사용자와 격리
- 동일한 이름의 TEMPORARY TABLE을 여러 세션이 동시에 생성이 가능합니다.
#### 4. 테이블 명은 겉보기엔 같아도 내부적으로는 고유함
- DB가 세션 ID 등을 기반으로 내부적으로 구분 처리를 합니다.
#### 5. 퍼포먼스 최적화
- 일부 DB는 temp영역을 메모리 기반으로 처리하여 빠릅니다.
#### 6. 트랜잭션 롤백과 무관
- 트랜잭션이 롤백되어도 temp table 자체는 유지됩니다. (이 부분은 주의해야 하는데, 아래서 자세히 설명하겠습니다.)


## 둘이 구조적으로 어떤 차이가 있는 거지?
사실 JOIN이 더 유리하다는 결과가 나왔지만, 정확히 내부적으로 어떤 동작을 하길래 이렇게 되는지는 여전히 의문이 남아 있었습니다.
이 부분은 내일 추가로 정리하겠습니다.

## TEMPOARAY 테이블의 롤백에 대하여
